# 卡尔曼滤波

对离散线性动态系统
$$
x_k=A*x_{k-1}+B*u_k+w_{k-1}\space(状态更新方程)\\
z_k=H*x_k+v_k\space (量测方程)
$$
其中，x为系统状态矩阵，z为状态量测矩阵，A为状态转移矩阵，B为输入控制矩阵，H为状态观测矩阵，w和v为过程噪声和量测噪声且符合均值为0，协方差分别为Q和R的正态分布

**卡尔曼滤波的思想为综合状态最优估计过程中的预测误差和量测误差**

对于状态估计算法，一般可以获取状态的三个值，真实值x，预测值$\tilde x^-$，也称先验估计值，最优估计值$\tilde x$，也称后验估计值。有
$$
\tilde x_k^-=A\tilde x_{k-1}+Bu_k&(1)\\
\tilde x_k=\tilde x_k^-+K(z_k-H\tilde x_k^-) &(2)\\
K=P_k^-H^T(HP_k^-H^T+R)^{-1}&(3)\\
P_k=(I-KH)P_k^-&(4)\\
P_{k+1}^-=AP_kA^T+Q&(5)\\
其中，K为卡尔曼增益，是预测误差占预测和量测误差之和的比重，P_k^-\\为真实值与预测值之间的协方差，P_k为真实值与最优估计值之间的协方差
$$
卡尔曼滤波的估计原则就是使最优估计的协方差最小，求解卡尔曼增益的求解过程为求协方差矩阵的迹对卡尔曼增益矩阵的偏导为0的点。

# Mahony滤波与四元数解算

对于x轴旋转其旋转矩阵为$R_x(\theta)=\begin{bmatrix}1&0&0\\0&\cos(\theta)&-\sin(\theta)\\0&\sin(\theta)&\cos(\theta)\end{bmatrix}$,多轴旋转只需把旋转矩阵相乘$R=R_x(\alpha)R_y(\beta)R_z(\gamma)$,其与欧拉角对应关系为$\alpha=arctan2(R_{32},R_{33}),\beta=-arcsin(R_{31}),\gamma=arctan2(R_{21},R_{11})$，arctan2表示两个向量的夹角

+ 四元数

  运算与复数类似，在解算角度时，三个虚轴系数表示旋转轴，实数部分表示角度

  由于四元数本身不是一个数域，在使用时必须用单位四元数

设四元数$q=q_0+q_1i+q_2j+q_3k=[q_0,u]$,被旋转量拓展到四维$v\rightarrow V=[0,v]$,则旋转操作表示为共轭旋转$V^{'}=qVq^{-1}$，其中q把V拉到四维，q的倒数把V又拉回三维，实际执行两次旋转，故单位四元数q表示的旋转为$q=(\cos(\frac\theta2),u\sin(\frac\theta2))$.

在实际使用时，为了求得四元数四个参数，使用微分$\dot q=0.5q*\dot u$，其中星号表示四元数乘法，有$q*p=\begin{bmatrix}q_0&-q_1&-q_2&-q_3\\q_1&q_0&-q_3&q_2\\q_2&q_3&q_0&-q_1\\q_3&-q_2&q_1&q_0\end{bmatrix}u$

因此可以从陀螺仪获取的速度数据积分出四元数参数

用四元数参数表示的旋转矩阵为

$\begin{bmatrix}1-2q_2^2-2q_3^2&2q_1q_2-2q_0q_3&2q_1q_3+2q_0q_2\\2q_1q_2+2q_0q_3&1-2q_1^2-2q_3^2&2q_2q_3-2q_0q_1\\2q_1q_3-2q_0q_2&2q_2q_3+2q_0q_1&q-2q_2^2-2q_2^2\end{bmatrix}$

+ mahony滤波

  只有角速度积分会导致漂移，需要真实的加速度去修正积分的误差，且动态情况下会受影响

  在实际测量时，计算得到的角速度对应求出得到加速度a与实际重力加速度g有偏差，单位化a，g后叉乘得到偏差角度的正弦值，又因为小角直接近似为偏差角度，对偏差角度进行PI控制后补偿到测量出的速度上即为真实速度

$单位化a,g,a\times g=sin(\theta)\approx \theta,gyro_{real}=gyro_{measure}+K_p\theta+K_i\int\theta dt$

# 滑膜控制

施工中......[滑模变结构控制 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/386592978)
